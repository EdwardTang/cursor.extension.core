# Oppie.xyz 快照清理与管理策略

## 1. 概述

本文档定义了Oppie.xyz系统中快照(checkpoint)的生命周期管理、存储策略和清理机制。合理的快照管理策略对于保证系统稳定性、支持故障恢复的同时避免资源浪费至关重要。

## 2. 快照分类与优先级

根据快照的重要性和用途，将快照分为以下几类：

| 快照类型 | 描述 | 优先级 | 示例 |
|---------|------|--------|------|
| 里程碑快照 | 标记重要功能完成或版本发布的快照 | 最高 | 主要功能模块完成、重要bug修复完成 |
| 用户触发快照 | 由用户手动触发创建的快照 | 高 | 开发者在尝试风险操作前手动创建 |
| 计划阶段快照 | 在计划生成后、执行前创建的快照 | 中 | 每个规划-执行循环开始前 |
| 执行阶段快照 | 在执行过程中按频率创建的快照 | 中 | 每N个工具调用后或每X分钟 |
| 自动周期快照 | 系统按固定时间间隔自动创建的快照 | 低 | 每小时自动快照 |

## 3. 快照保留策略

### 3.1 基于时间的保留策略

| 快照类型 | 短期保留(活跃任务) | 中期保留(完成任务) | 长期保留(归档) |
|---------|-------------------|-------------------|---------------|
| 里程碑快照 | 永久保留 | 永久保留 | 永久保留 |
| 用户触发快照 | 7天 | 30天 | 90天 |
| 计划阶段快照 | 3天 | 7天 | 30天 |
| 执行阶段快照 | 2天 | 5天 | 15天 |
| 自动周期快照 | 1天 | 3天 | 7天 |

### 3.2 基于空间的保留策略

系统将监控快照存储使用情况，当总存储空间超过预设阈值时，触发清理机制：

1. **低磁盘空间警告** (使用率 > 70%)：
   - 提前清理自动周期快照，仅保留最近12小时
   - 提前清理执行阶段快照，压缩保留频率为每4小时一个

2. **磁盘空间紧急** (使用率 > 85%)：
   - 清理所有自动周期快照，仅保留最近1小时的快照
   - 清理执行阶段快照，仅保留每个任务最新的3个快照
   - 压缩计划阶段快照，仅保留每个任务最新的快照
   - 向用户发送紧急通知

3. **磁盘空间危急** (使用率 > 95%)：
   - 保留所有里程碑快照
   - 仅保留最近24小时内的用户触发快照
   - 暂停自动快照创建功能
   - 每个活跃任务仅保留最新一个快照
   - 锁定执行环境直到用户手动清理或扩展存储

### 3.3 基于版本的保留策略

对于长期运行的任务，采用渐进式稀疏备份策略：

- 最近24小时：保留所有快照
- 1-3天：每小时保留1个快照
- 3-7天：每天保留2个快照(早/晚)
- 7-30天：每天保留1个快照
- 30-90天：每周保留1个快照
- 90天以上：每月保留1个快照

## 4. 快照清理机制

### 4.1 清理流程

1. **清理准备**：
   - 生成待清理快照列表
   - 验证每个待清理快照不是任何依赖链中的唯一节点
   - 确认有更新的快照可以替代被清理的快照

2. **安全清理**：
   - 对待清理快照进行完整性校验
   - 写入清理日志(包含快照元数据)
   - 执行实际删除操作
   - 更新快照索引数据库

3. **清理验证**：
   - 验证清理后系统状态正常
   - 确认相关依赖服务正常访问
   - 更新存储使用统计

### 4.2 自动清理触发条件

系统将在以下条件下触发自动清理：

- 定时触发：每天凌晨3点执行标准清理
- 空间触发：当存储使用率超过70%时触发
- 任务触发：当任务状态变为"已完成"或"已取消"时
- 手动触发：管理员可以手动启动清理流程

## 5. 快照存储架构

### 5.1 存储层次结构

采用多级存储策略，根据快照类型和年龄分配不同存储层次：

1. **热存储层**：
   - 存储内容：活跃任务的最新快照、所有里程碑快照
   - 存储介质：高性能SSD或内存缓存
   - 访问特性：低延迟，高吞吐

2. **温存储层**：
   - 存储内容：近期完成任务的快照、次新的活跃任务快照
   - 存储介质：标准SSD
   - 访问特性：中等延迟，中等吞吐

3. **冷存储层**：
   - 存储内容：非活跃任务的历史快照、归档数据
   - 存储介质：HDD或对象存储服务
   - 访问特性：较高延迟，批量访问优化

### 5.2 快照压缩策略

为优化存储空间使用，系统采用以下压缩策略：

- **增量快照**：仅存储与上一个快照的差异内容
- **去重技术**：识别并仅存储一次重复数据块
- **压缩算法**：对文本数据应用gzip压缩，对二进制数据应用专用压缩
- **存储时间优化**：
  - 热存储：不压缩或轻度压缩，优先恢复速度
  - 温存储：中度压缩，平衡恢复速度和存储效率
  - 冷存储：高度压缩，优先存储效率

## 6. 恢复性能指标

快照管理策略设计时考虑了以下恢复性能指标：

| 性能指标 | 目标值 | 测量方法 |
|---------|--------|---------|
| 热快照恢复时间 | < 30秒 | 从热存储恢复到工作状态的平均时间 |
| 温快照恢复时间 | < 3分钟 | 从温存储恢复到工作状态的平均时间 |
| 冷快照恢复时间 | < 10分钟 | 从冷存储恢复到工作状态的平均时间 |
| 快照创建对系统性能影响 | < 5% 吞吐下降 | 创建快照期间vs正常运行时的系统性能对比 |
| 恢复成功率 | > 99.9% | 恢复请求成功完成的百分比 |

## 7. 监控与告警

### 7.1 快照系统监控指标

系统将监控以下与快照相关的指标：

- 快照总数和各类型数量
- 快照存储空间使用率
- 快照创建和恢复操作的频率与耗时
- 快照创建和清理失败率
- 快照恢复成功率和平均恢复时间

### 7.2 告警阈值

| 告警类型 | 阈值 | 严重性 | 响应措施 |
|---------|------|--------|---------|
| 快照创建失败 | 连续2次 | 警告 | 记录日志，重试 |
| 快照创建失败 | 连续5次 | 严重 | 通知用户，暂停自动创建 |
| 存储空间使用率 | > 80% | 警告 | 触发提前清理，通知管理员 |
| 存储空间使用率 | > 90% | 严重 | 执行紧急清理，通知用户 |
| 快照恢复失败 | 任何失败 | 严重 | 尝试回退到上一个快照，通知用户 |

## 8. 管理员操作指南

### 8.1 手动清理命令

管理员可以使用以下命令手动触发快照清理：

```bash
# 标准清理，应用默认策略
oppie-admin checkpoint clean

# 指定时间范围清理
oppie-admin checkpoint clean --before 2025-01-01

# 紧急清理，保留最低限度快照
oppie-admin checkpoint clean --emergency

# 清理特定任务的快照
oppie-admin checkpoint clean --task-id <task_id>
```

### 8.2 恢复最佳实践

1. 始终优先尝试恢复最新的快照
2. 如果最新快照恢复失败，尝试前一个快照
3. 对于严重损坏的情况，考虑恢复到里程碑快照
4. 恢复后执行健康检查验证系统功能正常

## 9. 与其他系统集成

### 9.1 源代码管理集成

快照系统与Git版本控制集成：

- 里程碑快照自动创建Git标签
- 快照创建时记录当前Git提交哈希
- 提供从Git提交恢复到对应快照的功能

### 9.2 外部存储集成

支持将指定类型快照导出至外部存储系统：

- AWS S3或兼容对象存储
- NFS网络文件系统
- 外部版本控制系统

## 10. 合规与审计

### 10.1 快照更改日志

系统维护详细的快照操作日志，包含：

- 快照创建、恢复、删除等操作记录
- 操作用户和时间戳
- 操作原因（自动/手动，触发条件）
- 操作结果和相关指标

### 10.2 审计要求

为满足审计要求，系统将：

- 保留所有快照操作日志最少365天
- 提供只读访问审计日志的接口
- 支持按时间范围、操作类型等条件检索日志
- 防止日志篡改（使用哈希链或类似技术）
