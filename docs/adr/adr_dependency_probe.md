# 依赖服务探针与切换策略

## 状态

提议

## 背景

Oppie.xyz系统依赖多个外部服务以实现完整功能，包括UI-TARS、billd-desk和OpenHands。为确保系统在这些依赖服务不稳定或不可用时能够保持高可用性和自愈能力，需要建立健康探针、切换阈值和备选方案机制。

这个架构决策记录(ADR)定义了:
1. 各依赖服务的健康探针实现方式
2. 服务切换阈值与判定机制
3. 各服务的备选方案
4. 服务回切的判定标准

## 决策

### 1. 健康探针实现

| 依赖服务 | 探针类型 | 探测频率 | 探针实现方式 | 响应超时 |
|--------|---------|---------|------------|---------|
| UI-TARS | HTTP GET | 30秒 | curl -f https://{ui-tars-host}/health | 5秒 |
| billd-desk | GRPC Health | 45秒 | grpc_health_probe -addr={bd-host}:50051 | 3秒 |
| OpenHands | WebSocket Ping | 15秒 | ws.ping() | 2秒 |

探针执行逻辑：
- 所有健康探针作为独立后台线程执行
- 探针结果记录到内存计数器和持久化日志
- 探针状态通过内部事件总线广播给系统其他组件

### 2. 切换阈值

采用多层探针阈值策略：

| 依赖服务 | 警告阈值 | 回退阈值 | 重试冷却期 | 
|--------|---------|---------|------------|
| UI-TARS | 2次连续失败 | 3次连续失败 | 60秒 |
| billd-desk | 3次连续失败 | 5次连续失败 | 90秒 |
| OpenHands | 2次连续失败 | 3次连续失败 | 45秒 |

阈值判定逻辑：
- 警告阈值触发时，生成系统警告并提前预热备选服务
- 回退阈值触发时，自动切换到备选服务
- 在重试冷却期内，系统会暂停对原服务的健康检查，避免频繁切换
- 对于关键操作路径，单次超时直接触发警告

### 3. 备选方案

每个依赖服务都有指定的备选方案，按优先级排序：

#### 3.1 UI-TARS备选方案

1. **本地轻量级UI模拟器**：
   - 实现了UI-TARS核心接口的简化版本
   - 支持基本的GUI控制命令（点击、输入、滚动）
   - 响应时间<50ms，但功能有限
   - 适用场景：简单UI操作，非复杂交互

2. **命令行回退模式**：
   - 完全绕过GUI，使用CLI命令执行任务
   - 通过预定义的CLI命令映射表转换GUI指令
   - 适用场景：有等效CLI指令的操作

3. **操作延迟队列**：
   - 将UI操作请求存入持久化队列
   - UI-TARS恢复后批量执行
   - 适用场景：非实时操作，可延迟执行的任务

#### 3.2 billd-desk备选方案

1. **本地VNC控制器**：
   - 通过直接VNC连接替代billd-desk远程连接
   - 需要目标环境开启VNC服务
   - 适用场景：billd-desk不可用但目标环境可通过VNC访问

2. **ssh终端回退**：
   - 仅使用SSH终端连接执行命令
   - 无GUI能力，仅支持命令行操作
   - 适用场景：仅需命令行交互的任务

3. **任务暂停与重新调度**：
   - 暂停需要远程访问的任务
   - 优先调度本地可执行任务
   - 适用场景：远程任务非紧急，可推迟执行

#### 3.3 OpenHands备选方案

1. **独立执行模式**：
   - 绕过OpenHands事件总线，直接调用本地组件
   - 状态变更存储在本地缓存，后续同步
   - 适用场景：短期OpenHands不可用

2. **简化协调器**：
   - 使用内置的简化版事件总线
   - 仅支持核心事件类型
   - 仅保证本地一致性
   - 适用场景：中期OpenHands不可用

3. **批处理模式**：
   - 将任务转换为批处理模式
   - 减少对实时事件协调的依赖
   - 适用场景：长期OpenHands不可用

### 4. 回切策略

从备选方案回切到主要依赖服务的策略：

| 依赖服务 | 回切条件 | 观察期 | 回切方式 | 回切保护措施 |
|--------|---------|--------|--------|-----------| 
| UI-TARS | 5次连续成功响应 | 3分钟 | 渐进式，先路由20%流量 | 保留30分钟备选连接 |
| billd-desk | 3次连续成功响应 | 5分钟 | 会话结束时切换 | 新会话双写5分钟 |
| OpenHands | 10次连续成功响应 | 2分钟 | 即时切换 | 事件重放确认 |

回切判定细节：
- 成功响应必须包括完整的健康检查（不仅是连接测试）
- 观察期内，备选方案继续作为主要服务路径
- 回切过程中出现任何失败立即中止回切并重置观察期
- 对于UI-TARS，渐进式回切会在4小时内完成（20%→50%→100%）
- 所有回切操作都会记录详细日志用于后续分析

## 影响

### 积极影响
- 提高系统整体可用性，减少对单一依赖的敏感度
- 在依赖服务波动时提供平滑的降级体验
- 自动化的探测和切换减少人工干预需求
- 分层的切换策略避免误判和频繁切换

### 消极影响
- 增加系统复杂性，需要维护多套集成方案
- 备选方案通常功能受限，可能影响用户体验
- 探针和切换逻辑本身也可能成为故障点
- 回切过程中可能出现短暂的不一致状态

## 实施计划

1. **第一阶段（2周）**：实现基础健康探针
   - 为三个依赖服务实现标准健康检查
   - 集成到监控系统

2. **第二阶段（3周）**：开发UI-TARS和billd-desk的备选方案
   - 实现本地UI模拟器和VNC控制器
   - 建立命令行映射表

3. **第三阶段（2周）**：开发OpenHands备选方案
   - 实现独立执行模式和简化协调器

4. **第四阶段（1周）**：实现自动切换逻辑
   - 开发基于阈值的自动切换系统
   - 集成告警通知

5. **第五阶段（2周）**：实现回切策略
   - 开发回切判定和执行逻辑
   - 实现渐进式回切功能

6. **测试与验证（持续）**：
   - 注入故障测试自动切换和回切
   - 性能测试各备选方案的响应时间和资源消耗

## 合规与安全考虑

- 备选方案需要维护与主要服务相同的安全标准
- 所有凭证和敏感信息需加密存储
- 切换和回切操作需记录详细审计日志
- 手动触发切换需要适当的权限控制

## 结论

通过实施此依赖服务探针与切换策略，Oppie.xyz系统将显著提高其可靠性和弹性。即使在关键依赖不可用的情况下，系统仍能以降级模式继续运行，保障核心功能的连续性。备选方案虽然可能提供较受限的功能，但确保了系统不会因单一依赖故障而完全瘫痪。 