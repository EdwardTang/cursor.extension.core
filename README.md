# Oppie - Remote Cursor Control Mesh (RCCM)

Oppie是一个分布式系统，允许用户从移动设备远程启动并监控Cursor任务，具有自动恢复和高弹性的特点。

## 项目目标

- 实现自动恢复25工具调用限制和Template A缺失的问题
- 支持从移动设备远程触发和监控任务
- 在不稳定网络环境下保持系统的可靠性和性能
- 维持P95推送延迟<500ms的性能要求
- 实现≥40%的无人值守成功率

## 架构概述

系统由以下主要组件组成：

- **CursorCore**: 核心组件，负责状态管理和计划执行
- **ToolProxy**: 工具代理，包装MCP调用，提供计数和配额管理
- **MeshAdapter**: 网格适配器，负责节点间通信和状态同步
- **DevLoopWatcher**: 开发循环监视器，监控Cursor输出并触发恢复机制
- **SidecarDaemon**: Sidecar守护进程，用于远程控制和监控Cursor

## 优化亮点

### 1. 批处理机制

批处理机制对高延迟网络环境的性能改进最为显著：
- 在50ms延迟环境下：性能提升约33%
- 在200ms延迟环境下：性能提升约38%
- 在500ms延迟环境下：性能提升约41%

### 2. 自适应心跳

自适应心跳机制有效提高了网络不稳定环境下的系统稳定性：
- 在正常网络条件下，心跳频率逐渐降低，减少网络负载
- 在网络不稳定时，心跳频率自动增加，提高故障检测灵敏度
- 减少了心跳开销约45%，同时保持了系统的响应性

### 3. 深拷贝状态更新

使用深拷贝而不是简单引用更新，有效解决了分布式系统中的状态同步问题：
- 避免了跨节点引用导致的意外状态更改
- 提高了系统的可靠性和稳定性
- 成功率从80%提高到98%

### 4. 消息压缩

为大型消息实现了压缩机制：
- 仅对超过阈值（默认1KB）的消息进行压缩
- 使用gzip提供高效压缩
- 对于大型数据传输，减少了网络负载

### 5. 配置驱动开发

创建了统一的配置系统，使所有优化选项均可配置：
- 批处理参数（大小限制、时间限制）
- 心跳参数（初始间隔、最小/最大间隔、阈值）
- 性能监控参数（收集间隔、最大指标数）
- 网络优化参数（压缩阈值、重试设置）

## 性能测试成果

在不同网络条件下的系统性能：

| 测试环境 | 延迟(ms) | 丢包率(%) | 批处理 | P95延迟(ms) | 成功率(%) |
|---------|----------|----------|-------|------------|----------|
| 基线     | 0        | 0        | 否    | 8.25       | 100.00   |
| 基线     | 0        | 0        | 是    | 7.89       | 100.00   |
| 低延迟   | 50       | 0        | 否    | 120.56     | 99.50    |
| 低延迟   | 50       | 0        | 是    | 80.34      | 99.80    |
| 中等延迟 | 200      | 0        | 否    | 450.23     | 98.20    |
| 中等延迟 | 200      | 0        | 是    | 279.45     | 99.10    |
| 高延迟   | 500      | 0        | 否    | 1098.67    | 90.40    |
| 高延迟   | 500      | 0        | 是    | 648.92     | 97.80    |
| 高丢包   | 200      | 15       | 否    | 487.23     | 74.30    |
| 高丢包   | 200      | 15       | 是    | 312.45     | 88.90    |
| 极端环境 | 500      | 20       | 否    | 1345.67    | 65.40    |
| 极端环境 | 500      | 20       | 是+增强| 845.34    | 82.60    |

详细测试方法和结果请见 [性能基线文档](docs/perf_baseline.md)。

## 使用方法

### 安装依赖

```bash
pip install asyncio gzip pickle matplotlib numpy pytest
```

### 配置系统

编辑 `oppie/config.py` 文件，根据您的需求调整配置参数：

```python
# 网格适配器配置
MESH_CONFIG = {
    # 批处理配置
    "enable_batch_processing": True,  # 是否启用批处理
    "batch_size_limit": 10,           # 批处理大小限制
    "batch_time_limit_ms": 100,       # 批处理时间限制（毫秒）
    
    # 心跳配置
    "enable_adaptive_heartbeat": True,  # 是否启用自适应心跳
    "initial_heartbeat_interval": 1.0,  # 初始心跳间隔（秒）
    "min_heartbeat_interval": 0.2,      # 最小心跳间隔（秒）
    "max_heartbeat_interval": 5.0,      # 最大心跳间隔（秒）
    # ...其他配置
}
```

### 运行性能测试

```bash
cd tests/performance
python run_performance_tests.py
```

### 查看测试报告

```bash
open /tmp/oppie_perf/perf_report.html
```

## 下一步计划

1. 实现完整的重试机制，优化丢包环境下的表现
2. 添加背压控制，在网络拥塞时动态调整发送速率
3. 实现自动配置调整，根据网络条件自动优化系统
4. 扩展测试覆盖范围，确保所有优化在实际场景中的有效性

## 贡献者

- Oppie开发团队

## 许可证

MIT License